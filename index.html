<!DOCTYPE html>
<html>
<head>
  <title>Order Display</title>
  <meta name="viewport" content="width=100vw, initial-scale=1.0">
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: white;
      color: black;
      overflow: hidden;
    }

    .main-layout {
      display: flex;
      flex-direction: row;
      width: 100vw;
      height: 100vh;
    }

    .orders-panel {
      width: 33.33vw;
      height: 100vh;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      padding-top: 10px;
      padding-left: 10px;
      padding-right: 10px;
    }

    .orders-panel h1 {
      font-size: 2.2em; /* fallback for clamp */
      margin: 20px 0 10px 0;
      text-align: center;
    }

    #displayOrders {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(5, minmax(0, 1fr));
      grid-gap: 16px;
      width: 100%;
      height: calc(100vh - 100px);
      box-sizing: border-box;
      overflow-y: hidden;
    }

    .order {
      font-size: 4em; /* fallback for clamp */
      height: 100%;
      padding: 12px 8px;
      border: 4px solid black;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      text-align: center;
      word-break: break-word;
      box-sizing: border-box;
      background-clip: padding-box;
      line-height: 1.1;
    }

    .order.grabfood {
      font-size: 3.5em; /* fallback for clamp */
    }

    .grabfood {
      background: #00b74f;
      color: white;
    }

    .foodpanda {
      background: #e6007e;
      color: white;
    }

    .deliveroo {
      background: #00c2c7;
      color: white;
    }

    .takeaway {
      background: #f0f0f0;
      color: black;
    }

    .platform-label {
      font-size: 0.5em;
      margin-bottom: 10px;
    }

    .right-image-panel {
      width: 66.67vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #222;
      position: relative;
      overflow: hidden;
    }

    .alt-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      background-color: #222;
    }

    /* Responsive for smaller screens */
    @media (max-width: 600px) {
      .main-layout {
        flex-direction: column;
      }
      .orders-panel {
        width: 100vw;
        max-width: none;
        height: auto;
        padding: 10px 5px;
      }
      #displayOrders {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(10, 80px);
        height: auto;
        overflow-y: auto;
      }
      .order {
        font-size: 2em; /* fallback for clamp */
        height: 80px;
      }
      .right-image-panel {
        width: 100vw;
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="main-layout">
    <div class="orders-panel">
      <h1>Now Serving</h1>
      <div id="displayOrders"></div>
    </div>
    <div class="right-image-panel">
      <img id="altImage" class="alt-image" src="OKNEXTV1_1.jpg" alt="Alternating Image" />
    </div>
  </div>

  <audio id="ding" src="https://www.orangefreesounds.com/wp-content/uploads/2021/01/Ding-dong-sound.mp3" preload="auto"></audio>
  <input type="text" id="hiddenInput" onkeydown="handleKey(event)"
    style="opacity:0.01;position:absolute;left:0;top:0;width:1px;height:1px;z-index:1;"
    />

  <script>
    let orders = [];
    let speechQueue = [];
    let isSpeaking = false;

    function showOrders() {
      const display = document.getElementById('displayOrders');
      display.innerHTML = '';
      orders.forEach(order => {
        const div = document.createElement('div');
        div.className = 'order ' + order.platform;
        div.innerHTML = '<div class="platform-label">' + order.platformLabel + '</div>' + order.text;
        display.appendChild(div);
      });
    }

    function speakWithPause(order) {
      return new Promise(function(resolve) {
        var map = {
          '-': 'dash', '_': 'underscore', '/': 'slash', '\\': 'backslash',
          '.': 'dot', ',': 'comma', '#': '', '&': 'and', '@': 'at',
          '*': '', '+': 'plus', '=': 'equals', '%': 'percent', '$': 'dollar'
        };

        var sequence = [];
        for (var i = 0; i < order.length; i++) {
          var char = order[i];
          if (map[char] !== undefined) {
            if (map[char]) sequence.push(map[char]);
          } else if (/[a-zA-Z]/.test(char)) {
            sequence.push(char.toUpperCase());
          } else {
            sequence.push(char);
          }
        }

        var index = 0;
        function speakNext() {
          if (index >= sequence.length) {
            resolve();
            return;
          }
          speechSynthesis.cancel(); // For chromium 94 reliability
          var utterance = new SpeechSynthesisUtterance(sequence[index]);
          utterance.lang = 'en-GB';
          utterance.rate = 1;
          utterance.onend = function() {
            setTimeout(function() {
              index++;
              speakNext();
            }, 30);
          };
          speechSynthesis.speak(utterance);
        }
        speakNext();
      });
    }

    async function playDingAndSpeak(order) {
      isSpeaking = true;
      var ding = document.getElementById('ding');
      ding.pause();
      ding.currentTime = 0;
      try { await ding.play(); } catch (e) {}
      await new Promise(function(resolve) { setTimeout(resolve, 1000); });
      await speakWithPause(order);
      isSpeaking = false;
      if (speechQueue.length > 0) {
        var nextOrder = speechQueue.shift();
        playDingAndSpeak(nextOrder);
      }
    }

    function addOrder(raw) {
      var platform = '';
      var formattedOrder = raw;
      var label = '';
      var speakText = '';

      if (raw.startsWith('*')) {
        platform = 'grabfood';
        formattedOrder = 'GF-' + raw.slice(1);
        label = 'Grabfood';
        speakText = formattedOrder;
      } else if (raw.startsWith('/')) {
        platform = 'foodpanda';
        formattedOrder = '#' + raw.slice(1);
        label = 'Foodpanda';
        speakText = raw.slice(1);
      } else if (raw.startsWith('-')) {
        platform = 'deliveroo';
        formattedOrder = '#' + raw.slice(1);
        label = 'Deliveroo';
        speakText = raw.slice(1);
      } else {
        platform = 'takeaway';
        formattedOrder = raw;
        label = 'Takeaway';
        speakText = raw;
      }

      var newEntry = {
        text: formattedOrder,
        platform: platform,
        platformLabel: label
      };

      orders.unshift(newEntry);
      orders = orders.slice(0, 10);
      try { localStorage.setItem('orders', JSON.stringify(orders)); } catch (e) {}
      showOrders();

      if (isSpeaking) {
        speechQueue.push(speakText);
      } else {
        playDingAndSpeak(speakText);
      }
    }

    function handleKey(e) {
      if (e.key === 'Enter') {
        var value = e.target.value.trim();
        if (value) {
          addOrder(value);
        }
        e.target.value = '';
      }
    }

    function enterFullscreen() {
      var el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    window.onload = function() {
      try { localStorage.removeItem('orders'); } catch (e) {}
      orders = [];
      showOrders();

      var input = document.getElementById('hiddenInput');
      input.focus();

      window.addEventListener('click', function() {
        enterFullscreen();
        input.focus();
      });
      window.addEventListener('keydown', function() {
        enterFullscreen();
        input.focus();
      });
    };

    window.addEventListener('storage', function (e) {
      if (e.key === 'orders') {
        try {
          orders = JSON.parse(e.newValue || '[]');
        } catch (err) { orders = []; }
        showOrders();
        if (orders.length && !isSpeaking) playDingAndSpeak(orders[0].text);
      }
    });

    // Image alternator for the right panel
    var imageList = [
      "OKNEXTV1_1.jpg",
      "OKNEXTV1_2.jpg"
    ];
    var imgIndex = 0;

    function alternateImage() {
      imgIndex = (imgIndex + 1) % imageList.length;
      document.getElementById('altImage').src = imageList[imgIndex];
    }

    setInterval(alternateImage, 10000);
  </script>
</body>
</html>
